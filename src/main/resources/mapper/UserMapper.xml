<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.security.info.manage.mapper.UserMapper">
    <select id="selectUserInfo" resultType="com.security.info.manage.dto.req.UserReqDTO">
        select su.id, su.name, su.mobile, su.telephone, su.email, su.biz_mail, su.status, su.open_userid, su.main_dept, su.avatar,
        su.thumb_avatar, su.qr_code, su.address, su.gender, su.create_date, sue.user_name, sue.password, sue.user_no, sue.age
        from sys_user as su
        left join sys_user_ext as sue on sue.user_id=su.id and sue.is_delete=0
        where su.user_name=#{userName} and su.is_delete=0
        <if test="id!=null and id!=''">
            and su.id!=#{id}
        </if>
    </select>

    <select id="selectUserRoles" resultType="java.lang.String">
        select ar.role_id from sys_user_role as ar left join sys_role as r on r.id=ar.role_id and r.is_delete=0
        where ar.user_id=#{userId} and ar.is_delete=0 and r.status=0
    </select>

    <insert id="insertUser" parameterType="com.security.info.manage.dto.res.VxUserResDTO">
        TRUNCATE TABLE sys_user;
        insert into sys_user(id, name, mobile, telephone, email, biz_mail, status,
        open_userid, main_dept, avatar, thumb_avatar, qr_code, address, gender, create_by)
        values
        <foreach collection="list" index="index" item="user" separator=",">
            (#{user.userid}, #{user.name}, #{user.mobile}, #{user.telephone}, #{user.email}, #{user.biz_mail}, #{user.status},
            #{user.open_userid}, #{user.main_department}, #{user.avatar}, #{user.thumb_avatar}, #{user.qr_code}, #{user.address},
            #{user.gender}, #{doName})
        </foreach>
        ;
    </insert>

    <insert id="insertUserRole">
        insert into user_role(user_id,role_id,created_by,updated_by) values
        <foreach collection="roleIds" index="index" item="roleId" separator=",">
            (#{userId},#{roleId},#{doName},#{doName})
        </foreach>
    </insert>

    <update id="changePwd" parameterType="com.security.info.manage.dto.req.PasswordReqDTO">
        update sys_user set password=#{passwordReqDTO.newPwd},update_by=#{updateBy}
        where user_name=#{passwordReqDTO.userName} and password=#{passwordReqDTO.oldPwd}
    </update>

    <update id="editUser">
        update sys_user_ext
        <set>
            <if test="userReqDTO.userName!=null">
                user_name=#{userReqDTO.userName},
            </if>
            <if test="userReqDTO.password!=null">
                password=#{userReqDTO.password},
            </if>
            <if test="userReqDTO.userNo!=null">
                user_no=#{userReqDTO.userNo},
            </if>
            <if test="userReqDTO.age!=null">
                age=#{userReqDTO.age},
            </if>
            updated_by=#{updateBy}
        </set>
        where user_id=#{userReqDTO.id} and is_delete=0
    </update>

    <select id="listAllUser" resultType="com.security.info.manage.entity.User">
        select * from sys_user where is_delete=0 and status=0
    </select>

    <select id="listUser" resultType="com.security.info.manage.entity.User">
        select u.*, GROUP_CONCAT(ur.role_id) as user_roles from sys_user as u
        left join sys_user_role as ur on u.id=ur.user_id
        where u.is_delete=0
        <if test="status!=null">
            and u.status=#{status}
        </if>
        <if test="name!=null and name!=''">
            and u.name like CONCAT('%',#{name},'%')
        </if>
        group by u.id
    </select>

    <select id="selectUserId" resultType="java.lang.Long">
        select u.id from sys_user as u left join sys_user_ext as ue on ue.user_id=u.id and ue.is_delete=0
        where ue.user_name=#{userName} and u.is_delete=0
    </select>
</mapper>